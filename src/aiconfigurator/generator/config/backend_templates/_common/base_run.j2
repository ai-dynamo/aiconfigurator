{#
  Common shell script boilerplate for run.sh templates.
  This file provides shared environment setup and frontend launching.
#}

{% macro shell_header() %}
#!/bin/bash
set -e
trap 'echo "Cleaning up..."; kill 0 2>/dev/null || true' EXIT INT TERM
{% endmacro %}

{% macro env_setup(ServiceConfig, DynConfig) %}
# Common environment variables
export MODEL_PATH=${MODEL_PATH:-"{{ ServiceConfig.model_path }}"}
export HF_TOKEN=${HF_TOKEN:-"{{ ServiceConfig.hf_token }}"}
export SERVED_MODEL_NAME=${SERVED_MODEL_NAME:-"{{ ServiceConfig.served_model_name }}"}
export HEAD_NODE_IP=${HEAD_NODE_IP:-"{{ ServiceConfig.head_node_ip }}"}
export ETCD_ENDPOINTS="${HEAD_NODE_IP}:2379"
export NATS_SERVER="nats://${HEAD_NODE_IP}:4222"

{% set enable_router = DynConfig.enable_router | default(false) %}
{% if enable_router %}
export PYTHONHASHSEED=0
{% endif %}
{% endmacro %}

{% macro frontend(ServiceConfig, DynConfig) %}
{% set enable_router = DynConfig.enable_router | default(false) %}
{% if ServiceConfig.include_frontend %}
OTEL_SERVICE_NAME=dynamo-frontend \
python3 -m dynamo.frontend {% if enable_router %}--router-mode kv {% endif %}--http-port "{{ ServiceConfig.port }}" 2>&1 | sed "s/^/[Frontend] /" &
{% endif %}
{% endmacro %}
