{#
  vLLM backend Kubernetes DynamoGraphDeployment template
  Uses shared macros for worker specs.
#}
{% from 'base_k8s.j2' import deployment_header, frontend_spec %}
{% import 'vllm.j2' as vllm %}

{{ deployment_header(DynConfig, K8sConfig, name | default('dynamo-vllm')) }}
{{ frontend_spec(ServiceConfig, DynConfig, K8sConfig, enable_router | default(false), k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), frontend_replicas | default(1)) }}

{% set mode = DynConfig.mode | default('disagg') %}

{% if mode == 'agg' %}
{# ============ AGGREGATE MODE ============ #}
{{ vllm.k8s_worker(None, agg_gpu, agg_workers, agg_cli_args_list | default([]), ServiceConfig, K8sConfig, k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), runtime_working_dir | default('/workspace')) }}

{% else %}
{# ============ DISAGGREGATE MODE ============ #}
{{ vllm.k8s_worker('prefill', prefill_gpu, prefill_workers, prefill_cli_args_list | default([]), ServiceConfig, K8sConfig, k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), runtime_working_dir | default('/workspace')) }}
{{ vllm.k8s_worker('decode', decode_gpu, decode_workers, decode_cli_args_list | default([]), ServiceConfig, K8sConfig, k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), runtime_working_dir | default('/workspace')) }}
{% endif %}
