{#
  TRT-LLM worker launch macros.
  Used by both trtllm/run.sh.j2 and any/run.sh.j2
#}

{% macro run_worker(role, gpu, workers, gpu_offset, engine_args, enable_router) %}
{# 
  Launch TRT-LLM workers for a given role.
  Args:
    role: 'agg', 'prefill', or 'decode'
    gpu: GPUs per worker
    workers: Number of workers
    gpu_offset: Starting GPU index offset
    engine_args: Path to extra engine args YAML file
    enable_router: Whether to enable router mode
#}
{% set is_agg = role == 'agg' %}
{% set role_upper = role | upper %}
{% set worker_label = 'Worker' if is_agg else (role | capitalize) %}
{% set port_base = 8081 if is_agg else (8082 if role == 'prefill' else 8090) %}
{{ role_upper }}_GPU={{ gpu }}
{{ role_upper }}_WORKERS={{ workers }}
{{ role_upper }}_GPU_OFFSET={{ gpu_offset | default(0) }}
for ((w=0; w<{{ role_upper }}_WORKERS; w++)); do
  BASE=$(( {{ role_upper }}_GPU_OFFSET + w * {{ role_upper }}_GPU ))
  GPU_LIST=$(seq -s, $BASE $((BASE+{{ role_upper }}_GPU-1)))
  ( CUDA_VISIBLE_DEVICES=$GPU_LIST \
    DYN_SYSTEM_PORT=$(( {{ port_base }} + w )) \
    OTEL_SERVICE_NAME="dynamo-{{ role }}-$w" \
    python3 -m dynamo.trtllm \
    --model-path "$MODEL_PATH" \
    --served-model-name "$SERVED_MODEL_NAME" \
    --extra-engine-args "{{ engine_args }}" \
{% if not is_agg %}
    --disaggregation-mode {{ role }} \
{% endif %}
{% if enable_router %}
    --publish-events-and-metrics \
{% endif %}
    2>&1 | sed "s/^/[{{ worker_label }} $w] /" ) &
done
{% endmacro %}

{% macro k8s_worker(role, gpu, workers, engine_args, engine_args_inline, enable_router, ServiceConfig, K8sConfig, k8s_use_model_cache, k8s_model_cache_pvc, k8s_model_cache_mount, runtime_working_dir, use_engine_cm, engine_mount_path) %}
{#
  Kubernetes worker spec for TRT-LLM.
#}
{% set is_agg = role == 'agg' or role is none %}
{% set component_name = 'TRTLLMWorker' if is_agg else ('TRTLLM' ~ (role | capitalize) ~ 'Worker') %}
    {{ component_name }}:
      envFromSecret: hf-token-secret
      componentType: worker
      {% if role and not is_agg %}
      subComponentType: {{ role }}
      {% endif %}
      replicas: {{ workers }}
      resources:
        limits:
          gpu: "{{ gpu }}"
      extraPodSpec:
        {% if k8s_use_model_cache %}
        volumes:
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
        {% endif %}
        {% if K8sConfig.k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ K8sConfig.k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ prefill_k8s_image | default(decode_k8s_image | default(agg_k8s_image | default(K8sConfig.k8s_image | default(ServiceConfig.container_image | default(''))))) }}
          workingDir: {{ runtime_working_dir | default('/workspace') }}
          imagePullPolicy: IfNotPresent
          {% if k8s_use_model_cache %}
          volumeMounts:
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
          {% endif %}
          command: ["/bin/bash","-c"]
          args:
            - |
              set -euo pipefail
              {% if not use_engine_cm %}
              mkdir -p {{ engine_mount_path | default('/workspace/engine_configs') }}
              cat > {{ engine_args }} <<'YAML'
{{ (engine_args_inline | default('', true) | trim | indent(14, true)) }}
              YAML
              {% endif %}
              args=(
                --model-path "{{ ServiceConfig.model_path }}"
                --served-model-name "{{ ServiceConfig.served_model_name }}"
                --extra-engine-args "{{ engine_args }}"
              )
{% if not is_agg %}
              args+=(--disaggregation-mode {{ role }})
{% endif %}
{% if enable_router %}
              args+=(--publish-events-and-metrics)
{% endif %}
              exec python3 -m dynamo.trtllm "${args[@]}"
{% endmacro %}
