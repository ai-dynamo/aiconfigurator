{#
  TRT-LLM backend Kubernetes DynamoGraphDeployment template
  Uses shared macros for worker specs.
#}
{% from 'base_k8s.j2' import deployment_header, frontend_spec %}
{% import 'trtllm.j2' as trtllm %}

{# ConfigMap for engine args when using ConfigMap mode #}
{% if use_engine_cm | default(false) %}
{%- set agg_engine_key = agg_engine_args.split('/')[-1] -%}
{%- set prefill_engine_key = prefill_engine_args.split('/')[-1] -%}
{%- set decode_engine_key = decode_engine_args.split('/')[-1] -%}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ engine_cm_name | default('engine-config') }}
data:
  {% if DynConfig.mode | default('disagg') == 'agg' %}
  {{ agg_engine_key }}: |
{{ (agg_engine_args_inline | default('', true) | trim | indent(4, true)) }}
  {% else %}
  {{ prefill_engine_key }}: |
{{ (prefill_engine_args_inline | default('', true) | trim | indent(4, true)) }}
  {{ decode_engine_key }}: |
{{ (decode_engine_args_inline | default('', true) | trim | indent(4, true)) }}
  {% endif %}
---
{% endif %}

{{ deployment_header(DynConfig, K8sConfig, name | default('dynamo-trtllm')) }}
{{ frontend_spec(ServiceConfig, DynConfig, K8sConfig, enable_router | default(false), k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), frontend_replicas | default(1)) }}

{% set mode = DynConfig.mode | default('disagg') %}
{% set enable_router = DynConfig.enable_router | default(false) %}

{% if mode == 'agg' %}
{# ============ AGGREGATE MODE ============ #}
{{ trtllm.k8s_worker(None, agg_gpu, agg_workers, agg_engine_args, agg_engine_args_inline | default(''), enable_router, ServiceConfig, K8sConfig, k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), runtime_working_dir | default('/workspace'), use_engine_cm | default(false), engine_mount_path | default('/workspace/engine_configs')) }}

{% else %}
{# ============ DISAGGREGATE MODE ============ #}
{{ trtllm.k8s_worker('prefill', prefill_gpu, prefill_workers, prefill_engine_args, prefill_engine_args_inline | default(''), enable_router, ServiceConfig, K8sConfig, k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), runtime_working_dir | default('/workspace'), use_engine_cm | default(false), engine_mount_path | default('/workspace/engine_configs')) }}
{{ trtllm.k8s_worker('decode', decode_gpu, decode_workers, decode_engine_args, decode_engine_args_inline | default(''), enable_router, ServiceConfig, K8sConfig, k8s_use_model_cache | default(false), k8s_model_cache_pvc | default(''), k8s_model_cache_mount | default(''), runtime_working_dir | default('/workspace'), use_engine_cm | default(false), engine_mount_path | default('/workspace/engine_configs')) }}
{% endif %}
