{#
  vLLM worker launch macros.
  Used by both vllm/run.sh.j2 and any/run.sh.j2
#}

{% macro run_worker(role, gpu, workers, gpu_offset, cli_args, enable_router) %}
{# 
  Launch vLLM workers for a given role.
  Args:
    role: 'agg', 'prefill', or 'decode'
    gpu: GPUs per worker
    workers: Number of workers
    gpu_offset: Starting GPU index offset
    cli_args: Backend-specific CLI arguments string
    enable_router: Whether to enable router mode
#}
{% set is_agg = role == 'agg' %}
{% set role_upper = role | upper %}
{% set worker_label = 'Worker' if is_agg else (role | capitalize) %}
{% set port_base = 8081 if is_agg else (8082 if role == 'prefill' else 8090) %}
{% set event_port_base = 10000 + port_base %}
{% set side_channel_port_base = 20000 + port_base %}
{{ role_upper }}_GPU={{ gpu }}
{{ role_upper }}_WORKERS={{ workers }}
{{ role_upper }}_GPU_OFFSET={{ gpu_offset | default(0) }}
{{ role_upper }}_SYSTEM_PORT_BASE=${{ '{' }}{{ role_upper }}_SYSTEM_PORT_BASE:-{{ port_base }}{{ '}' }}
{{ role_upper }}_EVENT_PORT_BASE=${{ '{' }}{{ role_upper }}_EVENT_PORT_BASE:-{{ event_port_base }}{{ '}' }}
{{ role_upper }}_SIDE_CHANNEL_PORT_BASE=${{ '{' }}{{ role_upper }}_SIDE_CHANNEL_PORT_BASE:-{{ side_channel_port_base }}{{ '}' }}
for ((w=0; w<{{ role_upper }}_WORKERS; w++)); do
  BASE=$(( {{ role_upper }}_GPU_OFFSET + w * {{ role_upper }}_GPU ))
  GPU_LIST=$(seq -s, $BASE $((BASE+{{ role_upper }}_GPU-1)))
  SYSTEM_PORT=$(( {{ role_upper }}_SYSTEM_PORT_BASE + w ))
  EVENT_PORT=$(( {{ role_upper }}_EVENT_PORT_BASE + w ))
  SIDE_CHANNEL_PORT=$(( {{ role_upper }}_SIDE_CHANNEL_PORT_BASE + w ))
  ( DYN_SYSTEM_PORT=$SYSTEM_PORT \
    DYN_VLLM_KV_EVENT_PORT=$EVENT_PORT \
    VLLM_NIXL_SIDE_CHANNEL_PORT=$SIDE_CHANNEL_PORT \
    OTEL_SERVICE_NAME="dynamo-{{ role }}-$w" \
    CUDA_VISIBLE_DEVICES=$GPU_LIST \
    python3 -m dynamo.vllm \
    --model "$MODEL_PATH" \
{% if enable_router %}
    --kv-events-config "{\"publisher\":\"zmq\",\"topic\":\"kv-events\",\"endpoint\":\"tcp://*:${EVENT_PORT}\",\"enable_kv_cache_events\":true}" \
{% endif %}
    {{ cli_args }} \
{% if not is_agg %}
    --is-{{ role }}-worker \
{% endif %}
    2>&1 | sed "s/^/[{{ worker_label }} $w] /" ) &
done
{% endmacro %}

{% macro k8s_worker(role, gpu, workers, cli_args_list, ServiceConfig, K8sConfig, k8s_use_model_cache, k8s_model_cache_pvc, k8s_model_cache_mount, runtime_working_dir) %}
{#
  Kubernetes worker spec for vLLM.
#}
{% set is_agg = role == 'agg' or role is none %}
{% set component_name = 'VLLMWorker' if is_agg else ('VLLM' ~ (role | capitalize) ~ 'Worker') %}
{% set parsed_args = cli_args_list | default([]) %}
    {{ component_name }}:
      envFromSecret: hf-token-secret
      componentType: worker
      {% if role and not is_agg %}
      subComponentType: {{ role }}
      {% endif %}
      replicas: {{ workers | default(1) }}
      resources:
        limits:
          gpu: "{{ gpu }}"
      extraPodSpec:
        {% if k8s_use_model_cache %}
        volumes:
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
        {% endif %}
        {% if K8sConfig.k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ K8sConfig.k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ prefill_k8s_image | default(decode_k8s_image | default(agg_k8s_image | default(K8sConfig.k8s_image | default(ServiceConfig.container_image | default(''))))) }}
          workingDir: {{ runtime_working_dir | default('/workspace') }}
          imagePullPolicy: IfNotPresent
          {% if k8s_use_model_cache %}
          volumeMounts:
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
          {% endif %}
          command:
            - python3
            - -m
            - dynamo.vllm
          args:
            - --model
            - "{{ ServiceConfig.model_path }}"
            {% for arg in parsed_args %}
            - {{ arg | tojson }}
            {% endfor %}
{% if role == 'prefill' %}
            - --is-prefill-worker
{% elif role == 'decode' %}
            - --is-decode-worker
{% endif %}
{% endmacro %}
