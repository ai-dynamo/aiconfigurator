agg_decode cuda_graph_batch_sizes = ((range(1, 16 + 1, 1) | list) + (range(16, 32 + 1, 4) | list) + (range(32, 64 + 1, 8) | list) + (range(64, 128 + 1, 16) | list) + (range(128, 256 + 1, 32) | list) + (range(256, 512 + 1, 64) | list) + (range((1 if (max_batch_size or 0) <= 8 else (max_batch_size or 0) - 8), (max_batch_size or 0) + 8 + 1, 1) | list))

agg_decode cuda_graph_enable_padding = true

prefill max_batch_size = (max_batch_size if max_batch_size else 1)
agg_decode max_batch_size = (512 if (max_batch_size or 0) < 512 else (max_batch_size * 2))

prefill disable_overlap_scheduler = true
decode disable_overlap_scheduler = false
agg disable_overlap_scheduler = false

# Ensure maxNumTokens.value() % tokensPerBlock == 0 
agg_prefill_decode tokens_per_block = (tokens_per_block if tokens_per_block else 32)
prefill max_num_tokens = (((SlaConfig.isl + 1500) + tokens_per_block - 1) // tokens_per_block) * tokens_per_block
decode max_num_tokens = ((max_batch_size + tokens_per_block - 1) // tokens_per_block) * tokens_per_block
agg max_num_tokens = ((max_batch_size + SlaConfig.isl + 1500 + tokens_per_block - 1) // tokens_per_block) * tokens_per_block

# Enforce TensorRT-LLM MoE parallelism: moe_tp Ã— moe_ep = tp
when ModelConfig.is_moe and (moe_tensor_parallel_size and moe_expert_parallel_size):
    agg_prefill_decode tensor_parallel_size = moe_tensor_parallel_size * moe_expert_parallel_size

# GPUs per worker (fallback to 1 if any dimension missing)
agg_prefill_decode gpus_per_worker = (tensor_parallel_size or 1) * (pipeline_parallel_size or 1) * (data_parallel_size or 1)

agg_prefill_decode enable_attention_dp = ((data_parallel_size or 1) > 1) and ModelConfig.is_moe

when (ModelConfig.prefix or 0) > 0:
    agg_prefill_decode disable_prefix_cache = false
    DynConfig.enable_router = true


# Speculative decoding
when (ModelConfig.nextn or 0) > 0:
    agg_decode speculative_decoding_type = "MTP"
    agg_decode num_nextn_predict_layers = ModelConfig.nextn

when kv_cache_dtype in ("float16", "bfloat16"):
    kv_cache_dtype = "auto"
