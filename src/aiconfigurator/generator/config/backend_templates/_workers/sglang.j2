{#
  SGLang worker launch macros.
  Used by both sglang/run.sh.j2 and any/run.sh.j2
#}

{% macro run_worker(role, gpu, workers, gpu_offset, cli_args, enable_router) %}
{# 
  Launch SGLang workers for a given role.
  Args:
    role: 'agg', 'prefill', or 'decode'
    gpu: GPUs per worker
    workers: Number of workers
    gpu_offset: Starting GPU index offset
    cli_args: Backend-specific CLI arguments string
    enable_router: Whether to enable router mode
#}
{% set is_agg = role == 'agg' %}
{% set role_upper = role | upper %}
{% set worker_label = 'Worker' if is_agg else (role | capitalize) %}
{% set port_base = 8081 if is_agg else (8082 if role == 'prefill' else 8090) %}
{{ role_upper }}_GPU={{ gpu }}
{{ role_upper }}_WORKERS={{ workers }}
{{ role_upper }}_GPU_OFFSET={{ gpu_offset | default(0) }}
{{ role_upper }}_SYSTEM_PORT_BASE=${{ '{' }}{{ role_upper }}_SYSTEM_PORT_BASE:-{{ port_base }}{{ '}' }}
for ((w=0; w<{{ role_upper }}_WORKERS; w++)); do
  BASE=$(( {{ role_upper }}_GPU_OFFSET + w * {{ role_upper }}_GPU ))
  GPU_LIST=$(seq -s, $BASE $((BASE+{{ role_upper }}_GPU-1)))
  WORKER_IDX=$(( w + 1 ))
  SYSTEM_PORT=$(( {{ role_upper }}_SYSTEM_PORT_BASE + w ))
  WORKER_NAME="dynamo-{{ role }}"
  if (( {{ role_upper }}_WORKERS > 1 )); then
    WORKER_NAME="${WORKER_NAME}-${WORKER_IDX}"
  fi
  ( CUDA_VISIBLE_DEVICES=$GPU_LIST \
    OTEL_SERVICE_NAME="${WORKER_NAME}" \
    DYN_SYSTEM_PORT="${SYSTEM_PORT}" \
    python3 -m dynamo.sglang \
    --model-path "$MODEL_PATH" \
    --served-model-name "$SERVED_MODEL_NAME" \
    {{ cli_args }} \
{% if not is_agg %}
    --disaggregation-mode {{ role }} \
{% endif %}
    --host "0.0.0.0" \
    --enable-metrics 2>&1 | sed "s/^/[{{ worker_label }} $w] /" ) &
done
{% endmacro %}

{% macro k8s_worker(role, gpu, workers, cli_args, ServiceConfig, K8sConfig, k8s_use_model_cache, k8s_model_cache_pvc, k8s_model_cache_mount, runtime_working_dir) %}
{#
  Kubernetes worker spec for SGLang.
#}
{% set is_agg = role == 'agg' or role is none %}
{% set component_name = 'SGLANGWorker' if is_agg else ('SGLANG' ~ (role | capitalize) ~ 'Worker') %}
    {{ component_name }}:
      envFromSecret: hf-token-secret
      componentType: worker
      {% if role and not is_agg %}
      subComponentType: {{ role }}
      {% endif %}
      replicas: {{ workers | default(1) }}
      resources:
        limits:
          gpu: "{{ gpu }}"
      extraPodSpec:
        {% if k8s_use_model_cache %}
        volumes:
          - name: model-cache
            persistentVolumeClaim:
              claimName: {{ k8s_model_cache_pvc }}
        {% endif %}
        {% if K8sConfig.k8s_image_pull_secret %}
        imagePullSecrets:
          - name: {{ K8sConfig.k8s_image_pull_secret }}
        {% endif %}
        mainContainer:
          image: {{ prefill_k8s_image | default(decode_k8s_image | default(agg_k8s_image | default(K8sConfig.k8s_image | default(ServiceConfig.container_image | default(''))))) }}
          workingDir: {{ runtime_working_dir | default('/workspace') }}
          imagePullPolicy: IfNotPresent
          {% if k8s_use_model_cache %}
          volumeMounts:
            - name: model-cache
              mountPath: {{ k8s_model_cache_mount }}
          {% endif %}
          command: ["/bin/bash","-c"]
          args:
            - |
              set -euo pipefail
              args=(
                --model-path "{{ ServiceConfig.model_path }}"
                --served-model-name "{{ ServiceConfig.served_model_name }}"
                {{ cli_args }}
              )
              args+=(--host "0.0.0.0")
{% if not is_agg %}
              args+=(--disaggregation-mode {{ role }})
{% endif %}
              exec python3 -m dynamo.sglang "${args[@]}"
{% endmacro %}
