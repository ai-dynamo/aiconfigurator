{#
  vLLM backend run.sh template
  Uses shared macros for worker launching.
#}
{% from 'base_run.j2' import shell_header, env_setup, frontend %}
{% import 'vllm.j2' as vllm %}

{{ shell_header() }}

{{ env_setup(ServiceConfig, DynConfig) }}

{{ frontend(ServiceConfig, DynConfig) }}

{% set mode = DynConfig.mode | default('disagg') %}
{% set enable_router = DynConfig.enable_router | default(false) %}

{% if mode == 'agg' %}
{# ============ AGGREGATE MODE ============ #}
{{ vllm.run_worker('agg', agg_gpu, agg_workers, agg_gpu_offset | default(0), agg_cli_args, enable_router) }}
wait

{% else %}
{# ============ DISAGGREGATE MODE ============ #}
{% if prefill_workers|int > 0 %}
{{ vllm.run_worker('prefill', prefill_gpu, prefill_workers, prefill_gpu_offset | default(0), prefill_cli_args, enable_router) }}
{% endif %}

{% if decode_workers|int > 0 %}
{{ vllm.run_worker('decode', decode_gpu, decode_workers, decode_gpu_offset | default(0), decode_cli_args, enable_router) }}
{% endif %}
wait
{% endif %}
