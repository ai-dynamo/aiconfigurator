{#
  Heterogeneous backend template for run.sh
  This template composes worker launch logic from the appropriate backend
  using shared macros from _workers/ directory.
#}
{% from 'base_run.j2' import shell_header, env_setup, frontend %}
{% import 'sglang.j2' as sglang %}
{% import 'trtllm.j2' as trtllm %}
{% import 'vllm.j2' as vllm %}

{{ shell_header() }}

{{ env_setup(ServiceConfig, DynConfig) }}

{{ frontend(ServiceConfig, DynConfig) }}

{% set mode = DynConfig.mode | default('disagg') %}
{% set enable_router = DynConfig.enable_router | default(false) %}

{% if mode == 'agg' %}
{# ============ AGGREGATE MODE ============ #}
{% set backend = agg_backend | default('sglang') %}

{% if backend == 'sglang' %}
{{ sglang.run_worker('agg', agg_gpu, agg_workers, agg_gpu_offset | default(0), agg_cli_args, enable_router) }}
{% elif backend == 'vllm' %}
{{ vllm.run_worker('agg', agg_gpu, agg_workers, agg_gpu_offset | default(0), agg_cli_args, enable_router) }}
{% elif backend == 'trtllm' %}
{{ trtllm.run_worker('agg', agg_gpu, agg_workers, agg_gpu_offset | default(0), agg_engine_args, enable_router) }}
{% endif %}
wait

{% else %}
{# ============ DISAGGREGATE MODE ============ #}

{# ---- PREFILL WORKERS ---- #}
{% if prefill_workers|int > 0 %}
{% set p_backend = prefill_backend | default('sglang') %}

{% if p_backend == 'sglang' %}
{{ sglang.run_worker('prefill', prefill_gpu, prefill_workers, prefill_gpu_offset | default(0), prefill_cli_args, enable_router) }}
{% elif p_backend == 'vllm' %}
{{ vllm.run_worker('prefill', prefill_gpu, prefill_workers, prefill_gpu_offset | default(0), prefill_cli_args, enable_router) }}
{% elif p_backend == 'trtllm' %}
{{ trtllm.run_worker('prefill', prefill_gpu, prefill_workers, prefill_gpu_offset | default(0), prefill_engine_args, enable_router) }}
{% endif %}
{% endif %}

{# ---- DECODE WORKERS ---- #}
{% if decode_workers|int > 0 %}
{% set d_backend = decode_backend | default('sglang') %}

{% if d_backend == 'sglang' %}
{{ sglang.run_worker('decode', decode_gpu, decode_workers, decode_gpu_offset | default(0), decode_cli_args, enable_router) }}
{% elif d_backend == 'vllm' %}
{{ vllm.run_worker('decode', decode_gpu, decode_workers, decode_gpu_offset | default(0), decode_cli_args, enable_router) }}
{% elif d_backend == 'trtllm' %}
{{ trtllm.run_worker('decode', decode_gpu, decode_workers, decode_gpu_offset | default(0), decode_engine_args, enable_router) }}
{% endif %}
{% endif %}
wait
{% endif %}
